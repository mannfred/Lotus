####De novo Trinity assembly (v2.0.6)####
#input files are transcriptomes of Lotus filicaulis at two stages of floral colour change: 
#yellow (LFY.fastq) and red (LFR.fastq)

./Trinity --seqType fq --SS_lib_type FR --max_memory 20G  --left LFY_R1.fastq.gz,LFR_R1.fastq.gz 
	  --right LFY_R2.fastq.gz,LFR_R2.fastq.gz --CPU 6

#output: Trinity.fasta


#Concatanating Trinity Headers
cat ~/path/Trinity.fasta | cut -f 1 -d “ “ > Trinity.fasta.adj



#Abundance Estimation (FPKM) using RSEM built into Trinity

cd ~/path/Trinity/util  
#contains RSEM scripts and tools such as align_and_estimate_abundance.pl

#Quantify expression at red stage (FPKM)
./align_and_estimate_abundance.pl --seqType fq --left ~/path/LFR_R1.fastq --right ~/path/LFR_R2.fastq --transcripts   ~/path/trinity_out_dir/Trinity.fasta.adj --output_prefix LFR 	--est_method RSEM --aln_method bowtie --trinity_mode --prep_reference

#output: LFR.genes.results and LFR.isoforms.results


#Generate file (cumul_counts.txt) indicating counts over some threshold of FPKM
~/path/Trinity2/util/misc/count_features_given_MIN_FPKM_threshold.pl RSEM.genes.results > cumul_counts.txt
#output: 124875 contigs with >0 FPKM

#Create file containing transcript length information
cat ~/path/Trinity2/util/RSEM_RED_Aug28.genes.results | cut -f1,3,4 > 	trans_lengths.txt





####Measure differential expression####

#Build expression value matrix
./abundance_estimates_to_matrix.pl --est_method RSEM --out_prefix Trinity_trans LFY.genes.results LFR.genes.results

#output: Trinity_trans.counts.matrix (counts) and Trinity_trans.TMM.fpkm.matrix (fpkm normalized)


#Differential Expression Analysis by EdgeR

cd ~/path/Trinity/Analysis/DifferentialExpression/

./run_DE_analysis.pl --matrix ~/Downloads/Trinity2/util/Trinity_trans.counts.matrix --method 	edgeR

#output: Trinity_trans.counts.matrix.LFR_vs_LFY.edgeR.DE_results

